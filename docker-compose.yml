services:
  api:
    build:
      context: ./booksage
      dockerfile: api/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - BS_WORKER_ADDR=${BS_WORKER_ADDR:-worker:50051}
      - BS_OLLAMA_HOST=${BS_OLLAMA_HOST:-http://ollama:11434}
      - BS_USE_LOCAL_ONLY_LLM=${BS_USE_LOCAL_ONLY_LLM:-true}
      - BS_GEMINI_API_KEY=${BS_GEMINI_API_KEY}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 0.5G
    depends_on:
      worker:
        condition: service_started
      ollama:
        condition: service_started
      qdrant:
        condition: service_started
      neo4j:
        condition: service_started
    networks:
      - booksage-net

  worker:
    build:
      context: ./booksage
      dockerfile: worker/Dockerfile
    ports:
      - "50051:50051"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 6G
    networks:
      - booksage-net

  bookscout:
    build:
      context: .
      dockerfile: bookscout/Dockerfile
    environment:
      - BS_API_BASE_URL=${BS_API_BASE_URL:-http://api:8080/api/v1}
      - BS_OPDS_BASE_URL=${BS_OPDS_BASE_URL:-https://booklore.homelab.otama-playground.com/api/v1/opds}
    depends_on:
      api:
        condition: service_started
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - booksage-net

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - booksage-net

  neo4j:
    image: neo4j:5-community
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/booksage_dev}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
    volumes:
      - neo4j_data:/data
    networks:
      - booksage-net

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 12G
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - booksage-net

networks:
  booksage-net:
    driver: bridge

volumes:
  qdrant_data:
  neo4j_data:
  ollama_data:
